# Logic: Mapping URL -> Product Name

The system uses a sophisticated **6-Step Waterfall** approach to extract a clean product identity from a raw URL.

## The 6-Step Waterfall ðŸŒŠ

### Step 1: Link Resolution (The Un-Shortener)
First, we resolve shortened links (`amzn.to`, `bit.ly`) to their final destination.
*   **Method**: `HEAD` request to follow redirects.
*   **Goal**: Get the real URL where data lives.

### Step 2: HTML Metadata (The "Quick Peek") ðŸš€
**New**: Before doing anything heavy, we check if the page has structured data.
*   **Method**: Lightweight HTML fetch (timeout: 3s).
*   **Goal**: Extract:
    *   **Canonical URL** (`<link rel="canonical" ...>`)
    *   **JSON-LD** (`@type: Product`) - The Gold Standard.
    *   **OG Title** (`<meta property="og:title" ...>`)

### Step 3: Stable ID Extraction (The Fingerprint) ðŸ§¬
We scan the URL for known Product IDs.
*   **Regex**: `/(?:dp|gp/product)/([A-Z0-9]{10})` (Amazon ASIN).
*   **Why**: IDs are more accurate than names. If we find `B0F2THXY4T`, we know *exactly* what this is.

### Step 4: SerpAPI Strategy (The Google Fallback)
If metadata failed, we ask Google.
*   **Query**: `https://www.amazon.in/...`
*   **Method**: Google Search API.
*   **Goal**: Get the Title/Snippet that Google indexed.

### Step 5: Path Parsing (The Regex Fallback)
If external tools fail, we parse the URL text itself.
*   **Method**: Split URL (`/my-shoe-name/dp/...`) and clean hyphens.
*   **Goal**: Get a rough "best guess" name.

### Step 6: AI Refinement (The Polisher) âœ¨
Finally, we send the messy extracted text to **OpenAI (GPT-3.5)**.
*   **Input**: *"BRUTON Sport Shoes for Men Running White Size 10..."*
*   **Prompt**: *"Extract: 'product_name' (concise), 'brand'. Remove SEO filler."*
*   **Output**: "BRUTON Sport Shoes"
*   **Why**: Ensures we search for the *product*, not the *keywords*.

---

## Canonicalization Strategy
The user asked: *"Are we doing canonicalization?"*

**Answer: Yes, but in two specific layers.**

### 1. Technical Canonicalization (Redirect Resolution)
We **always** resolve the URL to its final destination and verify against `<link rel="canonical">`.

### 2. Parameter Handling (Fuzzy Canonicalization)
We **do not** aggressively strip all query parameters. Instead, we use **Normalization & Match Levels**.

*   **Normalization**: We strip tracking params (`utm_`, `ref`, `source`) and lowercase the URL.
*   **Match Levels**:
    1.  **ID Match** (+1500 pts): Does the ASIN match?
    2.  **Canonical Match** (+1200 pts): Do the official URLs match?
    3.  **Fuzzy/Prefix Match** (+800 pts): Is the URL fundamentally the same?

### 3. Stored Identity Fields (The Schema)
The system returns and uses the following fields to represent the "Canonical Form" of a product:

1.  **`product_id`** (The Fingerprint) ðŸ§¬
    *   Example: `{"type": "asin", "value": "B0F2THXY4T"}`
    *   **Usage**: The highest-priority match key. If this matches, everything else is ignored.
2.  **`canonical_url`** (The Publisher's Truth) ðŸ“œ
    *   Example: `https://www.amazon.in/dp/B0F2THXY4T`
    *   **Usage**: Extracted from HTML metadata. Used for exact link matching.
3.  **`resolved_url`** (The Technical Truth) ðŸ”—
    *   Example: `https://www.amazon.in/Bruton-Shoe.../dp/B0F2...`
    *   **Usage**: The final URL after following all redirects. Used as the base for normalization.
4.  **`match_key`** (The Fuzzy Key) ðŸ—ï¸
    *   **Calculated**: `_normalize_url(resolved_url)`
    *   Example: `amazon.in/bruton-shoe/dp/b0f2...`
    *   **Usage**: Used for fuzzy/prefix matching when IDs are missing.

### 4. How Match Key is Calculated (`_normalize_url`)
The `match_key` is generated by running the URL through a strict cleaner to ensure stable comparisons:

1.  **Lowercase Host**: `https://WWW.Amazon.in` -> `amazon.in` (and remove `www.`)
2.  **Filter Noise**: We remove specific "Transient" query parameters that don't change the product:
    *   `utm_source`, `utm_medium`, `utm_campaign`, `utm_term`, `utm_content`
    *   `ref`, `gclid`, `fbclid`
    *   (Note: We keep site-specific params like `th=1` (size/color) or `p_89` (brand) as they essentially define the variant).
3.  **Sort Parameters**: Returns params in alphabetical order so `?size=10&color=red` matches `?color=red&size=10`.
4.  **Strip Fragment**: Removes `#reviews` or `#specifications`.

This ensures that `amazon.in/p/123?ref=abc` and `Amazon.in/p/123?utm_source=google` both resolve to the **same key**: `amazon.in/p/123`.

